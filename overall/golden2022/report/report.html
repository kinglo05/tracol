<!DOCTYPE html>
<html>
<head>
    <title>Filtered Golden Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styleReport.css">
  
  

    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 95%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        th, td { border: 1px solid #333; padding: 6px; text-align: left; }
        th { background-color: #6d6060; color: white; }
        h2, h4, p { margin: 6px 0; text-align: center; }
        .summary { margin-top: 10px; }
        .page-break { page-break-before: always; }
    </style>

</head>
<body>
  

 <div id="backDiv" >
 <button id="backBTN"><a href="../clients/billAdmin2025.html">BACK</a></button>
  </div>


   <div id="topOption" class="babaw">
    <label>1.Start Date:</label>
    <input type="date" id="startDate">
    <br>
    <label>2.End Date:</label>
    <input type="date" id="endDate">
    <br>
    <input type="text" id="usernameDisplay" hidden>
    <!-- <button onclick="applyFilter()">Filter</button> -->
    <button id="filter" onclick=" applyFilter(); filterPayments(); filterPayments22();  loadUnpaidBillsWithFilters1();  selectedDateCollections(); lohwaExpenses(); rastyExpenses(); adminExpenses();" >3.Filter</button>
    
    <button id="pdfBtn" onclick="saveReportAsPDF()">Save as PDF</button>
    </div>



    <div id="pdf-content">

    <h2>Golden Transactions Report</h2>
    <p id="reportRange">Date range will be shown here</p>

    <div class="summary">
        <p><strong>Selected date total collections:</strong> <span id="totalFieldSelected">0</span></p>
         <p><strong>Total bills Approved: </strong> <span id="countFieldSelected">0</span></p>
        <p><strong>Additional income:</strong> <span id="totalCollected" >0.00</span></p>
        <p><strong>Total Expenses:</strong> <span id="totalExpens">0.00</span></p>
           <p><strong>NET Income:</strong> <span id="overAllTotal">0.00</span></p>
        
         <br>
         <p>Lohwa total collections received:  <span id="totalField">0</span></p>
         <p>Total bills lohwa Approved:  <span id="countField">0</span></p>
          <p>Lohwa Expenses:<span id="lohwaExpenses">0</span></p>


        <br>
         <p>Rasty Expenses: <span id="rastyExpenses">0</span></p>
         <p>Admin Expenses: <span id="adminExpenses">0</span></p>
        

        <input type="text" id="theUser" hidden>  
       
















<br>
    <h4>Additional Income/Collections</h4>
    <table id="payments-table">
        <thead>
            <tr><th>No.</th><th>Date</th><th>Amount</th><th>Name</th><th>Address</th><th>User</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr><td colspan="2" style="text-align:right;"><b>Total :</b></td><td id="table-total">0.00</td></tr>
        </tfoot>
    </table>

    <div class="page-break">
        <h4>Expenses</h4>
        <table id="payments-table2">
            <thead>
                <tr><th>No.</th><th>Date</th><th>Amount</th><th>Purpose</th><th>User</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr><td colspan="2" style="text-align:right;"><b>Total :</b></td><td id="table-total2">0.00</td></tr>
            </tfoot>
        </table>
    </div>

</div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>






/* function loadUnpaidBillsWithFilters1() {
  firebase.database().ref("goldenwifi/monthly-bills").once("value").then(snapshot => {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);
    endDate.setHours(23, 59, 59, 999); // include full end day

    let total = 0;

    snapshot.forEach(childSnap => {
      const billData = childSnap.val();
      if (!billData || !billData.bills) return;

    Object.keys(billData.bills).forEach(monthKey => {


  
  const record = billData.bills[monthKey];

  const billDate = new Date(record.date);
  const actionTo = (record.actionTo || "").trim().toLowerCase();
  const whoApproved = (record.whoApproved || "").trim().toLowerCase();

  // ðŸ”Ž debug raw amount
  console.log(`[${monthKey}] RAW amount value:`, record.planAmount);

  // clean and parse amount
  const rawAmount = record.planAmount || "0";
  const cleaned = rawAmount.toString().replace(/[^0-9.]/g, "");
  const amount = cleaned ? parseFloat(cleaned) : 0;

  if (
    billDate >= startDate &&
    billDate <= endDate &&
    actionTo === "approved" &&
    whoApproved === "lohwa"
  ) {
    console.log(`âœ… Included [${monthKey}] Amount parsed: ${amount}`);
    total += amount;
  }
});



    console.log("ðŸ”¢ Final Total:", total);
    document.getElementById("totalField").textContent = total.toFixed(2);
  });
}


  )};
 */



let startInput = document.getElementById("startDate").value;
let endInput = document.getElementById("endDate").value;

let startDate, endDate;

if (startInput && endInput) {
  // Use selected dates
  startDate = new Date(startInput);
  endDate = new Date(endInput);
  endDate.setHours(23, 59, 59, 999);
} else {
  // Auto-set to current month
  const today = new Date();

  // 1st day of current month
  startDate = new Date(today.getFullYear(), today.getMonth(), 1);

  // Last day of current month
  endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  endDate.setHours(23, 59, 59, 999);

  // (Optional) also update the input fields so user sees it
  document.getElementById("startDate").value = startDate.toISOString().split("T")[0];
  document.getElementById("endDate").value = endDate.toISOString().split("T")[0];
}
















function selectedDateCollections() {
  firebase.database().ref("goldenwifi/monthly-bills").once("value").then(snapshot => {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);
    endDate.setHours(23, 59, 59, 999); // include full end day

    let total = 0;
    let count = 0; // âœ… new counter

    snapshot.forEach(childSnap => {
      const billData = childSnap.val();
      if (!billData || !billData.bills) return;

      Object.keys(billData.bills).forEach(monthKey => {
        const record = billData.bills[monthKey];

        const billDate = new Date(record.date);
        const actionTo = (record.actionTo || "").trim().toLowerCase();
        const whoApproved = (record.whoApproved || "").trim().toLowerCase();

        const rawAmount = record.planAmount || "0";
        const cleaned = rawAmount.toString().replace(/[^0-9.]/g, "");
        const amount = cleaned ? parseFloat(cleaned) : 0;

        if (
          billDate >= startDate &&
          billDate <= endDate &&
          actionTo === "approved" 
         // whoApproved === "lohwa"
        ) {
          total += amount;
          count++; // âœ… count this bill
        }
      });
    });

    console.log("ðŸ”¢ Final Total:", total, "| Count:", count);

    // Show results in the DOM
    document.getElementById("totalFieldSelected").textContent = total.toFixed(2);
    document.getElementById("countFieldSelected").textContent = count; // âœ… needs an element in HTML
  });
}







function loadUnpaidBillsWithFilters1() {
  firebase.database().ref("goldenwifi/monthly-bills").once("value").then(snapshot => {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);
    endDate.setHours(23, 59, 59, 999); // include full end day

    let total = 0;
    let count = 0; // âœ… new counter

    snapshot.forEach(childSnap => {
      const billData = childSnap.val();
      if (!billData || !billData.bills) return;

      Object.keys(billData.bills).forEach(monthKey => {
        const record = billData.bills[monthKey];

        const billDate = new Date(record.date);
        const actionTo = (record.actionTo || "").trim().toLowerCase();
        const whoApproved = (record.whoApproved || "").trim().toLowerCase();

        const rawAmount = record.planAmount || "0";
        const cleaned = rawAmount.toString().replace(/[^0-9.]/g, "");
        const amount = cleaned ? parseFloat(cleaned) : 0;

        if (
          billDate >= startDate &&
          billDate <= endDate &&
          actionTo === "approved" &&
          whoApproved === "lohwa"
        ) {
          total += amount;
          count++; // âœ… count this bill
        }
      });
    });

    console.log("ðŸ”¢ Final Total:", total, "| Count:", count);

    // Show results in the DOM
    document.getElementById("totalField").textContent = total.toFixed(2);
    document.getElementById("countField").textContent = count; // âœ… needs an element in HTML
     updateFinal();
  });
}














function filterPayments() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999); // Include the full end day

  document.getElementById("reportRange").textContent = `From ${startDate} to ${endDate}`;

  const paymentsRef = firebase.database().ref("goldenwifi/transactions");
  const tableBody = document.querySelector("#payments-table tbody");
  const totalField = document.getElementById("table-total");

  tableBody.innerHTML = ""; // clear previous results
  let total = 0;

  paymentsRef.once("value", snapshot => {
    let count = 1;

    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date); // assumes 'data.date' is valid ISO or Date-parsable format

      if (
        date >= startDate &&
        date <= endDate &&
        data.status === "new"
      ) {
        const row = tableBody.insertRow();
        row.insertCell(0).textContent = count++;
        row.insertCell(1).textContent = data.date;
        row.insertCell(2).textContent = parseFloat(data.amountNew).toFixed(2);
        row.insertCell(3).textContent = data.clientName || "";
        row.insertCell(4).textContent = data.address || "";
        row.insertCell(5).textContent = data.user || "";
        total += parseFloat(data.amountNew);
      }
    });

    totalField.textContent = total.toFixed(2);
    document.getElementById("totalCollected").textContent = total.toFixed(2);
    updateFinal();
  });
}








function applyFilter() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        document.getElementById("reportRange").textContent = `From ${startDate} to ${endDate}`;

    
    }


function filterPayments22() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
  const tableBody = document.querySelector("#payments-table2 tbody");
  const totalField = document.getElementById("table-total2");
  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (date >= startDate && date <= endDate) {
        const row = tableBody.insertRow();
        row.insertCell(0).textContent = count++;
        row.insertCell(1).textContent = data.date;
        row.insertCell(2).textContent = parseFloat(data.amount).toFixed(2);
        row.insertCell(3).textContent = data.exName || "";
        row.insertCell(4).textContent = data.user || "";
        total += parseFloat(data.amount);
      }
    });

    totalField.textContent = total.toFixed(2);
    document.getElementById("totalExpens").textContent = total.toFixed(2);
    updateFinal();
  });
}



function lohwaExpenses() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
//  const tableBody = document.querySelector("#payments-table2 tbody");
//  const totalField = document.getElementById("table-total2");
//  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate && 
        date <= endDate &&
        data.user === "lohwa" &&
        data.actionTo ==="approved" &&
         data.status === "new"

      
      ) {
       
        total += parseFloat(data.amount);
      }
    });

    totalField.textContent = total.toFixed(2);
    document.getElementById("lohwaExpenses").textContent = total.toFixed(2);
    updateFinal();
  });
}




function rastyExpenses() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
//  const tableBody = document.querySelector("#payments-table2 tbody");
//  const totalField = document.getElementById("table-total2");
//  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate && 
        date <= endDate &&
        data.user === "rasty" &&
        data.actionTo ==="approved" &&
         data.status === "new"

      
      ) {
       
        total += parseFloat(data.amount);
      }
    });

    totalField.textContent = total.toFixed(2);
    document.getElementById("rastyExpenses").textContent = total.toFixed(2);
    updateFinal();
  });
}





function adminExpenses() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
//  const tableBody = document.querySelector("#payments-table2 tbody");
//  const totalField = document.getElementById("table-total2");
//  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate && 
        date <= endDate &&
        data.user === "admin" &&
        data.actionTo ==="approved" &&
        data.status === "new"

      
      ) {
       
        total += parseFloat(data.amount);
      }
    });

    totalField.textContent = total.toFixed(2);
    document.getElementById("adminExpenses").textContent = total.toFixed(2);
    updateFinal();
  });
}













function updateFinal() {
  const collected = parseFloat(document.getElementById("totalFieldSelected").textContent) || 0;
  const collected2 = parseFloat(document.getElementById("totalCollected").textContent) || 0;

   const overAll = collected + collected2;
  const expenses = parseFloat(document.getElementById("totalExpens").textContent) || 0;
  const final = overAll - expenses;
  document.getElementById("overAllTotal").textContent = final.toFixed(2);  
}




function saveReportAsPDF() {
    // Get values before excluding inputs from the PDF
    const startDate = document.getElementById("startDate")?.value || "Report";
    const todayDate = document.getElementById("endDate")?.value || "Report";

    const element = document.getElementById("pdf-content");

    html2pdf()
        .set({
            margin: [20, 20, 20, 10],
            filename: `From_${startDate}_TO_${todayDate}_Golden_Report.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        })
        .from(element)
        .save();
}






    </script>
 

<script>
  window.onload = function () {
    applyFilter();
    filterPayments();
    filterPayments22();
    loadUnpaidBillsWithFilters1();
    selectedDateCollections();
    lohwaExpenses();
    rastyExpenses();
    adminExpenses();
  };
</script>









</div> <!-- end of your content -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
<script src="scriptReport.js"></script>

</body>
</html>




</body>
</html>

