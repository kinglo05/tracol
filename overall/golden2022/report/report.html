<!DOCTYPE html>
<html>
<head>
    <title>Filtered Golden Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styleReport.css">
  
  

    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 95%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        th, td { border: 1px solid #333; padding: 6px; text-align: left; }
        th { background-color: #6d6060; color: white; }
        h2, h4, p { margin: 6px 0; text-align: center; }
        .summary { margin-top: 10px; }
        .page-break { page-break-before: always; }
    </style>

</head>
<body>
  

 <div id="backDiv" >
 <button id="backBTN"><a href="../clients/billAdmin2025.html">BACK</a></button>

<button id="showPayments"><a href="viewpayments/paidbills.html">SHOW PAID BILLS</a></button>

  </div>


   <div id="topOption" class="babaw">
    <label>1.Start Date:</label>
    <input type="date" id="startDate">
    <br>
    <label>2.End Date:</label>
    <input type="date" id="endDate">
    <br>
    <input type="text" id="usernameDisplay" hidden>
    <!-- <button onclick="applyFilter()">Filter</button> -->
    <button id="filter" onclick=" testPaid(), filterPayments(), filterPayments22(),  lohwaBillsApproved(),  lohwaExpenses(), rastyExpenses(), adminExpenses(), lohwaAddCollect(), loadUnpaidBillsWithFilters(), adminTotalApproved(), adminAddCollect()" >3.Filter</button>
    
    <button id="pdfBtn" onclick="saveReportAsPDF()">Save as PDF</button>
    </div>



    <div id="pdf-content">

    <h2>Golden Transactions Report</h2>
    <!-- <p id="reportRange">Date range will be shown here</p> -->

    <div class="summary">
        <!-- <p><strong>Selected date total collections:</strong> <span id="overAllCollection">0</span></p> -->
        <p><strong>Total collections month of <span id="startMonthLo"></span> to  <span id="endtMonthLo">  </span> :  <span id="totalFieldSelected">0</span> </strong> (by month)</p>
         <p>Total bills approved: <strong> <span id="countFieldSelected1">0</span></p></strong>

         <p>Collector/Admin Collections month of <span id="startMonthLo1"></span> to  <span id="endtMonthLo1">  </span> : <strong> <span id="totalAdmin">0</span></p> </strong>
        
       
        <p>Lohwa total collections month of <span id="startMonthLo2"></span> to  <span id="endtMonthLo2"></span> : <strong> <span id="totalField">0</span></p> </strong>
         <p>Total for all additional collections : <strong><span id="totalCollected" >0.00</span></p></strong>

          <p>(Lohwa additional collections:<span id="lohwaAddCollect">0</span>)</p>
           <p>(Admin additional collections:<span id="adminaAddCollect">0</span>)</p>
       
           <!-- <p><strong>NET Income:</strong> <span id="overAllTotal">0.00</span></p> -->
        
         <br>
         
         <!-- <p>Total bills lohwa Approved:  <span id="countField">0</span></p> -->

        <p><strong>Total expenses for the  month of <span id="startMonthEx"></span> to  <span id="endMonthEx"> </span></strong> (by date range) </p>
          
        <p>Lohwa Expenses:<span id="lohwaExpenses">0</span></p>
         <p>Rasty Expenses: <span id="rastyExpenses">0</span></p>
         <p>Admin Expenses: <span id="adminExpenses">0</span></p>
        

        <p><strong>Total Expenses: <span id="totalExpens">0.00</span></p></strong>

        <input type="text" id="theUser" hidden>  
       
















<br>
    <h4>Additional Income/Collections</h4>
    <table id="payments-table">
        <thead>
            <tr><th>No.</th><th>Date</th><th>Amount</th><th>Name</th><th>Address</th><th>User</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr><td colspan="2" style="text-align:right;"><b>Total :</b></td><td id="table-total">0.00</td></tr>
        </tfoot>
    </table>

    <div class="page-break">
        <h4>Expenses</h4>
        <table id="payments-table2">
            <thead>
                <tr><th>No.</th><th>Date</th><th>Amount</th><th>Purpose</th><th>User</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr><td colspan="2" style="text-align:right;"><b>Total :</b></td><td id="table-total2">0.00</td></tr>
            </tfoot>
        </table>
    </div>

</div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>


 let startInput = document.getElementById("startDate").value;
let endInput = document.getElementById("endDate").value; 

let startDate, endDate;

if (startInput && endInput) {
  // Use selected dates
  startDate = new Date(startInput);
  endDate = new Date(endInput);
  endDate.setHours(23, 59, 59, 999);
} else {
  // Auto-set to current month
  const today = new Date();

  // 1st day of current month
  startDate = new Date(today.getFullYear(), today.getMonth(), 1);

  // Last day of current month
  endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  endDate.setHours(23, 59, 59, 999);




  
  // (Optional) also update the input fields so user sees it
  document.getElementById("startDate").value = startDate.toISOString().split("T")[0];
  document.getElementById("endDate").value = endDate.toISOString().split("T")[0];

   document.getElementById("startMonthEx").textContent = startDate.toISOString().split("T")[0];
  document.getElementById("endMonthEx").textContent = endDate.toISOString().split("T")[0];

   

}



function selectedDateCollections() {
  firebase.database().ref("goldenwifi/monthly-bills").once("value").then(snapshot => {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);
    endDate.setHours(23, 59, 59, 999); // include full end day

    let total = 0;
    let count = 0; // ✅ new counter

    snapshot.forEach(childSnap => {
      const billData = childSnap.val();
      if (!billData || !billData.bills) return;

      Object.keys(billData.bills).forEach(monthKey => {
        const record = billData.bills[monthKey];

        const billDate = new Date(record.date);
        const actionTo = (record.actionTo || "").trim().toLowerCase();
        const whoApproved = (record.whoApproved || "").trim().toLowerCase();

        const rawAmount = record.planAmount || "0";
        const cleaned = rawAmount.toString().replace(/[^0-9.]/g, "");
        const amount = cleaned ? parseFloat(cleaned) : 0;

        if (
          billDate >= startDate &&
          billDate <= endDate &&
          actionTo === "approved" 
         // && whoApproved === "lohwa"
        ) {
          total += amount;
          count++; // ✅ count this bill
        }
      });
    });

   // console.log("Final Total final", total, "| Count:", count);

    // Show results in the DOM
   // document.getElementById("totalFieldSelected").textContent = total.toFixed(2);
  //  document.getElementById("countFieldSelected1").textContent = count; // ✅ needs an element in HTML
  });
}





function applyFilter() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
     //   document.getElementById("reportRange").textContent = `From ${startDate} to ${endDate}`;

    
    filterPayments();
     lohwaBillsApproved()
    filterPayments22();
  //  loadUnpaidBillsWithFilters();
   // selectedDateCollections();
   // lohwaBillsApproved()
    lohwaExpenses();
    rastyExpenses();
    adminExpenses();
    lohwaAddCollect();
    loadUnpaidBillsWithFilters();
    adminAddCollect();
    testPaid();
    updateFinal()


    }







function lohwaBillsApproved() {
  firebase.database().ref("goldenwifi/monthly-bills").once("value").then(snapshot => {
    // const startDate = new Date(document.getElementById("startDate").value);
    // const endDate = new Date(document.getElementById("endDate").value);
    // endDate.setHours(23, 59, 59, 999); // include full end day

const startDate = new Date(document.getElementById("startDate").value);
startDate.setDate(1);
startDate.setHours(0, 0, 0, 0);

const endDate = new Date(document.getElementById("endDate").value);
endDate.setMonth(endDate.getMonth() + 1, 0); // last day of month
endDate.setHours(23, 59, 59, 999);




    let total = 0;
    let count = 0; // ✅ new counter

    snapshot.forEach(childSnap => {
      const billData = childSnap.val();
      if (!billData || !billData.bills) return;

      Object.keys(billData.bills).forEach(monthKey => {
        const record = billData.bills[monthKey];

        const billDate = new Date(record.dateOfPayment);
        const actionTo = (record.actionTo || "").trim().toLowerCase();
        const whoApproved = (record.whoApproved || "").trim().toLowerCase();

        const rawAmount = record.planAmount || "0";
        const cleaned = rawAmount.toString().replace(/[^0-9.]/g, "");
        const amount = cleaned ? parseFloat(cleaned) : 0;
         


        if (
          billDate >= startDate &&
          billDate <= endDate &&
          actionTo === "approved" &&
          whoApproved === "lohwa"
        ) {
          total += amount;
          count++; // ✅ count this bill
        }
        
      });

     // console.log(" Final Total uproved HTML:", total.toFixed(2));
    });


   
  });
}





function filterPayments() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999); // Include the full end day

 // document.getElementById("reportRange").textContent = `From ${startDate} to ${endDate}`;

  const paymentsRef = firebase.database().ref("goldenwifi/transactions");
  const tableBody = document.querySelector("#payments-table tbody");
  const totalFieldTable = document.getElementById("table-total");

  tableBody.innerHTML = ""; // clear previous results
  let total = 0;

  paymentsRef.once("value", snapshot => {
    let count = 1;

    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date); // assumes 'data.date' is valid ISO or Date-parsable format

      if (
        date >= startDate &&
        date <= endDate &&
        data.status === "new"
      ) {
        const row = tableBody.insertRow();
        row.insertCell(0).textContent = count++;
        row.insertCell(1).textContent = data.date;
        row.insertCell(2).textContent = parseFloat(data.amountNew).toFixed(2);
        row.insertCell(3).textContent = data.clientName || "";
        row.insertCell(4).textContent = data.address || "";
        row.insertCell(5).textContent = data.user || "";
        total += parseFloat(data.amountNew);
      }
    });

    totalFieldTable.textContent = total.toFixed(2);
    document.getElementById("totalCollected").textContent = total.toFixed(2);
   // updateFinal();
  });
}




function filterPayments22() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
  const tableBody = document.querySelector("#payments-table2 tbody");
  const totalField22 = document.getElementById("table-total2");
  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate &&
         date <= endDate &&
          data.status === "new"
        
        ) {
        const row = tableBody.insertRow();
        row.insertCell(0).textContent = count++;
        row.insertCell(1).textContent = data.date;
        row.insertCell(2).textContent = parseFloat(data.amount).toFixed(2);
        row.insertCell(3).textContent = data.exName || "";
        row.insertCell(4).textContent = data.user || "";
        total += parseFloat(data.amount);
      }
    });

    totalField22.textContent = total.toFixed(2);
    document.getElementById("totalExpens").textContent = total.toFixed(2);
    updateFinal();
  });
}




function lohwaExpenses() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
//  const tableBody = document.querySelector("#payments-table2 tbody");
  const totalFieldx = document.getElementById("table-total2");
//  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate && 
        date <= endDate &&
        data.user === "lohwa" &&
      //  data.actionTo ==="approved" &&
         data.status === "new"

      
      ) {
       
        total += parseFloat(data.amount);
      }
    });

    totalFieldx.textContent = total.toFixed(2);
    document.getElementById("lohwaExpenses").textContent = total.toFixed(2);
   // updateFinal();
  });
}






function lohwaAddCollect() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999); // Include the full end day

 // document.getElementById("reportRange").textContent = `From ${startDate} to ${endDate}`;

  const paymentsRef = firebase.database().ref("goldenwifi/transactions");
 const tableBody = document.querySelector("#payments-table tbody");
  const totalFieldLoCol = document.getElementById("table-total");

  tableBody.innerHTML = ""; // clear previous results
  let total = 0;

  paymentsRef.once("value", snapshot => {
    let count = 1;

    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date); // assumes 'data.date' is valid ISO or Date-parsable format

      if (
        date >= startDate &&
        date <= endDate &&
        data.status === "new" &&
        data.user ==="lohwa"
      ) {
      
        total += parseFloat(data.amountNew);
      }
    });

    totalFieldLoCol.textContent = total.toFixed(2);
    document.getElementById("lohwaAddCollect").textContent = total.toFixed(2);
    updateFinal();
  });
}



function adminAddCollect() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999); // Include the full end day

 // document.getElementById("reportRange").textContent = `From ${startDate} to ${endDate}`;

  const paymentsRef = firebase.database().ref("goldenwifi/transactions");
 const tableBody = document.querySelector("#payments-table tbody");
  const totalFieldLoCol = document.getElementById("table-total");

  tableBody.innerHTML = ""; // clear previous results
  let total = 0;

  paymentsRef.once("value", snapshot => {
    let count = 1;

    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date); // assumes 'data.date' is valid ISO or Date-parsable format

      if (
        date >= startDate &&
        date <= endDate &&
        data.status === "new" &&
        data.user ==="admin"
      ) {
      
        total += parseFloat(data.amountNew);
      }
    });

    totalFieldLoCol.textContent = total.toFixed(2);
    document.getElementById("adminaAddCollect").textContent = total.toFixed(2);
   // updateFinal();
  });
}






function rastyExpenses() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
//  const tableBody = document.querySelector("#payments-table2 tbody");
  const totalFieldx = document.getElementById("table-total2");
//  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate && 
        date <= endDate &&
        data.user === "rasty" &&
        data.actionTo ==="approved" &&
         data.status === "new"

      
      ) {
       
        total += parseFloat(data.amount);
      }
    });

    totalFieldx.textContent = total.toFixed(2);
    document.getElementById("rastyExpenses").textContent = total.toFixed(2);
   // updateFinal();
  });
}





function adminExpenses() {
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  endDate.setHours(23, 59, 59, 999);

  const expensesRef = firebase.database().ref("goldenwifi/goldenExpenses");
//  const tableBody = document.querySelector("#payments-table2 tbody");
  const totalFieldAd = document.getElementById("table-total2");
//  tableBody.innerHTML = "";
  let total = 0;

  expensesRef.once("value", snapshot => {
    let count = 1;
    snapshot.forEach(child => {
      const data = child.val();
      const date = new Date(data.date);

      if (
        date >= startDate && 
        date <= endDate &&
        data.user === "admin" &&
       
        data.actionTo ==="approved" &&
        data.status === "new"

      
      ) {
       
        total += parseFloat(data.amount);
      }
    });

    totalFieldAd.textContent = total.toFixed(2);
    document.getElementById("adminExpenses").textContent = total.toFixed(2);
   // updateFinal();
  });
}








totalAdmin




function updateFinal() {
  const collectedAdmin = parseFloat(document.getElementById("totalAdmin").textContent) || 0;
  const collectedExtra = parseFloat(document.getElementById("totalCollected").textContent) || 0;
  const collectedLo = parseFloat(document.getElementById("totalField").textContent) || 0;
  const collectedAd = parseFloat(document.getElementById("adminaAddCollect").textContent) || 0;

   const overAll = collectedAdmin + collectedLo + collectedExtra;
  const expenses = parseFloat(document.getElementById("totalExpens").textContent) || 0;
  const final = overAll - expenses;
 // document.getElementById("overAllCollection").textContent = overAll.toFixed(2);
  document.getElementById("totalFieldSelected").textContent = overAll.toFixed(2); 
 // console.log("OverAll total:", overAll); 
}




function saveReportAsPDF() {
    // Get values before excluding inputs from the PDF
    const startDate = document.getElementById("startDate")?.value || "Report";
    const todayDate = document.getElementById("endDate")?.value || "Report";

    const element = document.getElementById("pdf-content");

    html2pdf()
        .set({
            margin: [20, 20, 20, 10],
            filename: `From_${startDate}_TO_${todayDate}_Golden_Report.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        })
        .from(element)
        .save();
}






    </script>
 

<script>
  window.onload = function () {
   //applyFilter();
    filterPayments();
     lohwaBillsApproved()
    filterPayments22();
  //  loadUnpaidBillsWithFilters();
    selectedDateCollections();
   // lohwaBillsApproved()
    lohwaExpenses();
    rastyExpenses();
    adminExpenses();
   // lohwaAddCollect();
   adminAddCollect();
    loadUnpaidBillsWithFilters();
    adminTotalApproved();
    testPaid();
    updateFinal()
  };
</script>









</div> <!-- end of your content -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
<script src="scriptReport.js"></script>

</body>
</html>




</body>
</html>
