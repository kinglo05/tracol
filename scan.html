<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GCash Payment Scanner</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    
  <style>
  
 .video-container {
    position: relative;
    display: inline-block;
  }

  video {
    width: 80%;
    height: auto;
    border-radius: 8px;
  }

  /* Dark overlay */
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    pointer-events: none;
    clip-path: inset(0 0 0 0);
  }

  /* Scanner guide box */
 #scanBox {
  position: absolute;
  border: 3px dashed #00ffcc;
  border-radius: 8px;
  resize: both;
  overflow: auto;
  min-width: 80px;
  min-height: 80px;
  max-width: 90%;
  max-height: 90%;
  cursor: move;
  box-sizing: border-box;
}

/* Make resize handles bigger */
#scanBox::-webkit-resizer {
  width: 24px;
  height: 24px;
  background: rgba(0, 255, 204, 0.5);
  border-radius: 4px;
}

/* Add "corner brackets" look for scanner feel */
#scanBox::before,
#scanBox::after {
  content: "";
  position: absolute;
  width: 20px;
  height: 20px;
  border: 3px solid #00ffcc;
}

#scanBox::before {
  top: -3px;
  left: -3px;
  border-right: none;
  border-bottom: none;
}

#scanBox::after {
  bottom: -3px;
  right: -3px;
  border-left: none;
  border-top: none;
}


  /* Laser scanning line */
  .laser {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(0, 255, 0, 0.9);
    box-shadow: 0 0 8px rgba(0, 255, 0, 0.8);
    animation: scanAnim 2s linear infinite;
  }

  @keyframes scanAnim {
    0% { top: 0; opacity: 1; }
    45% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { top: 100%; opacity: 1; }
  }



    button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #previewBox {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #f9f9f9;
      display: none;
    }
    #previewBox input {
      width: 90%;
      padding: 6px;
      margin: 4px 0;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .error {
      border: 2px solid red !important;
      background: #ffe6e6;
    }
    .note {
      color: red;
      font-size: 13px;
      margin: 0;
    }







    
  </style>
</head>
<body>
    <div id="usernameHolder">  <h5 id="usernameDisplay" style="color: rgb(237, 236, 243); margin-top: 1px; margin-bottom: 1px; margin-left: 10px;">Loading...</h5>  </div>
  <h2>GCash Payment Scanner</h2>



<!--   <video id="video" autoplay playsinline></video> -->

<div class="video-container" id="videoContainer">
  <video id="video" autoplay playsinline></video>
  <div class="overlay"></div>
  <div id="scanBox" class="scan-box">
    <div class="laser"></div>
  </div>
</div>

<div class="controls">
  <label>Contrast: 
    <input type="range" id="contrastSlider" min="100" max="400" value="200"> 
    <span id="contrastValue">200%</span>
  </label>
  
  <label>Brightness: 
    <input type="range" id="brightnessSlider" min="50" max="200" value="120"> 
    <span id="brightnessValue">120%</span>
  </label>

  <label>
    <input type="checkbox" id="grayscaleToggle"> Grayscale
  </label>
</div>


<button id="scanBtn">üì∑ Scan</button>
<div id="result"></div>




<!-- Interact.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>



<!-- 
  <br>
  <button id="scanBtn">üì∑ Scan</button>
  <p id="result"></p> -->

  <!-- Editable Preview Section -->
  <div id="previewBox">
    <h3>Preview & Confirm</h3>
    <p><b>Amount:</b><br>
      <input type="text" id="prevAmount"><br>
      <span id="noteAmount" class="note"></span>
    </p>
    <p><b>Reference:</b><br>
      <input type="text" id="prevRef"><br>
      <span id="noteRef" class="note"></span>
    </p>
    <p><b>Date:</b><br>
      <input type="text" id="prevDate"><br>
      <span id="noteDate" class="note"></span>
    </p>
    <p><b>Time:</b><br>
      <input type="text" id="prevTime"><br>
      <span id="noteTime" class="note"></span>
    </p>
    <button id="confirmBtn">‚úÖ Confirm & Save</button>
    <button id="cancelBtn">‚ùå Cancel</button>
  </div>

  <script>
    // Firebase Config (replace with yours)
    const firebaseConfig = {
      apiKey: "AIzaSyCYe3m5O6X1-q47u1w1GQ4bT8pAvJ5tzq8",
  authDomain: "tracollector.firebaseapp.com",
  databaseURL: "https://tracollector-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tracollector",
  storageBucket: "tracollector.firebasestorage.app",
  messagingSenderId: "520928034041",
  appId: "1:520928034041:web:1e5facfbe4ddb5e55e7628",
  measurementId: "G-YPW4TB6P51"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();


     const app = firebase.initializeApp(firebaseConfig); 
     const database = firebase.database();


firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    console.log("User is logged in:", user.uid);

    // Fetch user data from Firebase Database
    firebase.database().ref("users/" + user.uid).once("value")
    .then(snapshot => {
        if (snapshot.exists()) {
            const userData = snapshot.val();
            document.getElementById("usernameDisplay").innerText = "Welcome, " + userData.email;
        } else {
            console.log("No user data found!");
        }
    })
    .catch(error => {
        console.error("Error fetching user data:", error);
    });
     
     
  } else {
      console.log("No user is signed in. Redirecting to login...");
      window.location.href = "index.html"; // Redirect if not logged in
  } 
});




const video = document.getElementById("video");
//const scanBox = document.getElementById("scanBox");
const overlay = document.getElementById("overlay");
const container = document.getElementById("videoContainer");

// Initialize scan box
video.addEventListener("loadedmetadata", () => {
  const defaultWidth = video.clientWidth * 0.5;
  const defaultHeight = video.clientHeight * 0.3;
  const defaultX = (video.clientWidth - defaultWidth) / 2;
  const defaultY = (video.clientHeight - defaultHeight) / 2;

  scanBox.style.width = defaultWidth + "px";
  scanBox.style.height = defaultHeight + "px";
  scanBox.style.left = defaultX + "px";
  scanBox.style.top = defaultY + "px";

  updateOverlay();
});

// Enable drag + resize
interact("#scanBox")
  .draggable({
    listeners: {
      move(event) {
        const target = event.target;
        const x = (parseFloat(target.getAttribute("data-x")) || 0) + event.dx;
        const y = (parseFloat(target.getAttribute("data-y")) || 0) + event.dy;

        target.style.transform = `translate(${x}px, ${y}px)`;
        target.setAttribute("data-x", x);
        target.setAttribute("data-y", y);

        updateOverlay();
      }
    }
  })
  .resizable({
    edges: { left: true, right: true, bottom: true, top: true }
  })
  .on("resizemove", function (event) {
    const target = event.target;
    let x = parseFloat(target.getAttribute("data-x")) || 0;
    let y = parseFloat(target.getAttribute("data-y")) || 0;

    target.style.width = event.rect.width + "px";
    target.style.height = event.rect.height + "px";

    x += event.deltaRect.left;
    y += event.deltaRect.top;

    target.style.transform = `translate(${x}px, ${y}px)`;
    target.setAttribute("data-x", x);
    target.setAttribute("data-y", y);

    updateOverlay();
  });

// Update overlay cut-out
function updateOverlay() {
  const videoRect = container.getBoundingClientRect();
  const boxRect = scanBox.getBoundingClientRect();

  const left = boxRect.left - videoRect.left;
  const top = boxRect.top - videoRect.top;
  const right = videoRect.width - (boxRect.right - videoRect.left);
  const bottom = videoRect.height - (boxRect.bottom - videoRect.top);

  overlay.style.clipPath = `polygon(
    0 0, 
    100% 0, 
    100% 100%, 
    0 100%, 
    0 ${top}px, 
    ${left}px ${top}px, 
    ${left}px ${top + boxRect.height}px, 
    ${left + boxRect.width}px ${top + boxRect.height}px, 
    ${left + boxRect.width}px ${top}px, 
    ${left}px ${top}px, 
    0 ${top}px
  )`;
}











   // const video = document.getElementById("video");
    let capturedData = {};

    // Start camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => alert("Camera error: " + err));







  function formatDateToISO(dateString) {
  try {
    const dateObj = new Date(dateString);
    if (!isNaN(dateObj)) {
      // Format in local time (YYYY-MM-DD)
      const year = dateObj.getFullYear();
      const month = String(dateObj.getMonth() + 1).padStart(2, "0");
      const day = String(dateObj.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
  } catch (e) {}
  return "";
}






    function extractFields(text) {
      let amount = null;
      let refNumber = null;
      let date = null;
      let time = null;

      // Amount
      const amountMatch = text.match(/(?:‚Ç±|PHP|Amount)\s*[+\-]?([\d,]+(?:\.\d{2})?)/i);
      if (amountMatch) {
        amount = parseFloat(amountMatch[1].replace(/,/g, ""));
      }

      // Reference number
      const refMatch = text.match(/\b(\d{10,})/);
      if (refMatch) {
        refNumber = refMatch[1].replace(/[^0-9]/g, "");
      }

      // Date + Time
      const dateTimeMatch = text.match(/([A-Za-z]{3,9}\s+\d{1,2},\s+\d{4})\s+(\d{1,2}:\d{2}\s*(?:AM|PM))/i);
      if (dateTimeMatch) {
        date = dateTimeMatch[1];
        time = dateTimeMatch[2];
      }

      return { amount, refNumber, date, time };
    }

    // Validate inputs and highlight issues
    function validateInputs() {
      let isValid = true;

      // Amount
      const amt = document.getElementById("prevAmount");
      const noteAmt = document.getElementById("noteAmount");
      if (!amt.value || isNaN(amt.value) || parseFloat(amt.value) <= 0) {
        amt.classList.add("error");
        noteAmt.textContent = "‚ö† Invalid amount";
        isValid = false;
      } else {
        amt.classList.remove("error");
        noteAmt.textContent = "";
      }

      // Reference
      const ref = document.getElementById("prevRef");
      const noteRef = document.getElementById("noteRef");
      if (!/^\d{10,}$/.test(ref.value)) {
        ref.classList.add("error");
        noteRef.textContent = "‚ö† Reference should be at least 10 digits";
        isValid = false;
      } else {
        ref.classList.remove("error");
        noteRef.textContent = "";
      }

      // Date
      const date = document.getElementById("prevDate");
      const noteDate = document.getElementById("noteDate");
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date.value)) {
        date.classList.add("error");
        noteDate.textContent = "‚ö† Use YYYY-MM-DD format";
        isValid = false;
      } else {
        date.classList.remove("error");
        noteDate.textContent = "";
      }

      // Time
      const time = document.getElementById("prevTime");
      const noteTime = document.getElementById("noteTime");
      if (time.value && !/^\d{1,2}:\d{2}\s?(AM|PM)$/i.test(time.value)) {
        time.classList.add("error");
        noteTime.textContent = "‚ö† Use format hh:mm AM/PM";
        isValid = false;
      } else {
        time.classList.remove("error");
        noteTime.textContent = "";
      }

      return isValid;
    }

    // Handle Scan button

 // Handle Scan button
/* document.getElementById("scanBtn").addEventListener("click", async () => {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const videoRect = video.getBoundingClientRect();
  const scanRect = scanBox.getBoundingClientRect();

  const scaleX = video.videoWidth / videoRect.width;
  const scaleY = video.videoHeight / videoRect.height;

  const roiX = (scanRect.left - videoRect.left) * scaleX;
  const roiY = (scanRect.top - videoRect.top) * scaleY;
  const roiWidth = scanRect.width * scaleX;
  const roiHeight = scanRect.height * scaleY;

  canvas.width = roiWidth;
  canvas.height = roiHeight;

  ctx.drawImage(video, roiX, roiY, roiWidth, roiHeight, 0, 0, roiWidth, roiHeight);

  const { data: { text } } = await Tesseract.recognize(canvas, "eng");

  const { amount, refNumber, date, time } = extractFields(text);



  document.getElementById("scanBtn").addEventListener("click", async () => {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const videoRect = video.getBoundingClientRect();
  const scanRect = scanBox.getBoundingClientRect();

  const scaleX = video.videoWidth / videoRect.width;
  const scaleY = video.videoHeight / videoRect.height;

  const roiX = (scanRect.left - videoRect.left) * scaleX;
  const roiY = (scanRect.top - videoRect.top) * scaleY;
  const roiWidth = scanRect.width * scaleX;
  const roiHeight = scanRect.height * scaleY;

  canvas.width = roiWidth;
  canvas.height = roiHeight;

  // ‚úÖ Apply contrast & brightness filter before drawing
  // contrast(200%) doubles contrast, brightness(120%) makes it slightly brighter
 ctx.filter = "contrast(200%) brightness(120%)";
//  ctx.filter = "contrast(220%) brightness(130%) grayscale(100%)";

  ctx.drawImage(video, roiX, roiY, roiWidth, roiHeight, 0, 0, roiWidth, roiHeight);

  // (Optional) remove filter so it doesn‚Äôt affect later drawings
  ctx.filter = "none";

  // OCR on enhanced image
  const { data: { text } } = await Tesseract.recognize(canvas, "eng");

  const { amount, refNumber, date, time } = extractFields(text);

  if (amount && refNumber) {
    capturedData = {
      amount,
      refNumber,
      date: formatDateToISO(date || new Date()),
      time: time || ""
    };

    document.getElementById("prevAmount").value = capturedData.amount;
    document.getElementById("prevRef").value = capturedData.refNumber;
    document.getElementById("prevDate").value = capturedData.date;
    document.getElementById("prevTime").value = capturedData.time;
    document.getElementById("previewBox").style.display = "block";

    validateInputs();
  } else {
    document.getElementById("result").innerText =
      "‚ö†Ô∏è Could not extract payment details. Try again.";
  }
});












  if (amount && refNumber) {
    capturedData = {
      amount,
      refNumber,
      date: formatDateToISO(date || new Date()),
      time: time || ""
    };

    document.getElementById("prevAmount").value = capturedData.amount;
    document.getElementById("prevRef").value = capturedData.refNumber;
    document.getElementById("prevDate").value = capturedData.date;
    document.getElementById("prevTime").value = capturedData.time;
    document.getElementById("previewBox").style.display = "block";

    validateInputs();
  } else {
    document.getElementById("result").innerText =
      "‚ö†Ô∏è Could not extract payment details. Try again.";
  }
});

 */

const contrastSlider = document.getElementById("contrastSlider");
const brightnessSlider = document.getElementById("brightnessSlider");
const contrastValue = document.getElementById("contrastValue");
const brightnessValue = document.getElementById("brightnessValue");
const grayscaleToggle = document.getElementById("grayscaleToggle");
const videoEl = document.getElementById("video");
const scanBox = document.getElementById("scanBox");

// üé• Apply live preview filters
function updateVideoFilter() {
  const contrast = contrastSlider.value;
  const brightness = brightnessSlider.value;
  contrastValue.textContent = contrast + "%";
  brightnessValue.textContent = brightness + "%";
  const grayscale = grayscaleToggle.checked ? "grayscale(100%)" : "none";
  videoEl.style.filter = `contrast(${contrast}%) brightness(${brightness}%) ${grayscale}`;
}

contrastSlider.addEventListener("input", updateVideoFilter);
brightnessSlider.addEventListener("input", updateVideoFilter);
grayscaleToggle.addEventListener("change", updateVideoFilter);

// ‚úÖ Initial filter apply
updateVideoFilter();

document.getElementById("scanBtn").addEventListener("click", async () => {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const videoRect = videoEl.getBoundingClientRect();
  const scanRect = scanBox.getBoundingClientRect();

  const scaleX = videoEl.videoWidth / videoRect.width;
  const scaleY = videoEl.videoHeight / videoRect.height;

  const roiX = (scanRect.left - videoRect.left) * scaleX;
  const roiY = (scanRect.top - videoRect.top) * scaleY;
  const roiWidth = scanRect.width * scaleX;
  const roiHeight = scanRect.height * scaleY;

  canvas.width = roiWidth;
  canvas.height = roiHeight;

  // ‚ö° Apply same filter to capture as live video
  const contrast = contrastSlider.value;
  const brightness = brightnessSlider.value;
  const grayscale = grayscaleToggle.checked ? "grayscale(100%)" : "none";
  ctx.filter = `contrast(${contrast}%) brightness(${brightness}%) ${grayscale}`;

  ctx.drawImage(videoEl, roiX, roiY, roiWidth, roiHeight, 0, 0, roiWidth, roiHeight);

  ctx.filter = "none";

  // Run OCR
  const { data: { text } } = await Tesseract.recognize(canvas, "eng");

  const { amount, refNumber, date, time } = extractFields(text);

  if (amount && refNumber) {
    capturedData = {
      amount,
      refNumber,
      date: formatDateToISO(date || new Date()),
      time: time || ""
    };

    document.getElementById("prevAmount").value = capturedData.amount;
    document.getElementById("prevRef").value = capturedData.refNumber;
    document.getElementById("prevDate").value = capturedData.date;
    document.getElementById("prevTime").value = capturedData.time;
    document.getElementById("previewBox").style.display = "block";

    validateInputs();
  } else {
    document.getElementById("result").innerText =
      "‚ö†Ô∏è Could not extract payment details. Try adjusting contrast/brightness or toggling grayscale.";
  }
});




    // Confirm button ‚Üí save to Firebase
    document.getElementById("confirmBtn").addEventListener("click", () => {
      if (!validateInputs()) {
        alert("‚ö† Please fix highlighted fields before saving.");
        return;
      }

      capturedData = {
        amount: document.getElementById("prevAmount").value,
        refNumber: document.getElementById("prevRef").value,
        date: document.getElementById("prevDate").value,
        time: document.getElementById("prevTime").value,
        status: "new",
        save: "scanned"
      };

      const newRef = db.ref("payments").push();
      const save = "scaned";
       const status = "new";
      newRef.set(capturedData);
      document.getElementById("result").innerText =
        `‚úÖ Saved! Amount: ${capturedData.amount}, Ref: ${capturedData.refNumber}, Date: ${capturedData.date}, saving: ${save}, status: ${status}, Time: ${capturedData.time || "N/A"}`;
      document.getElementById("previewBox").style.display = "none";
    });

    // Cancel button ‚Üí discard
    document.getElementById("cancelBtn").addEventListener("click", () => {
      capturedData = {};
      document.getElementById("previewBox").style.display = "none";
      document.getElementById("result").innerText = "‚ùå Scan cancelled.";
    });
  </script>
</body>
</html>

